pipeline {
  agent {
    kubernetes {
      yaml """
        apiVersion: v1
        kind: Pod
        spec:
          containers:
          - name: centos
            image: centos
            command:
            - sleep
            args:
            - 99d
          - name: gradle
            image: gradle:jdk8
            command:
            - sleep
            args:
            - 99d
          restartPolicy: Never
      """
    }
  }
  stages {
    stage('Checkout code and start a calculator') {
      steps {
        git 'https://github.com/meadowlark1/Continuous-Delivery-with-Docker-and-Jenkins-Second-Edition.git'
        container('centos') {
          sh '''
            cd Chapter08/sample1
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x ./kubectl
            ./kubectl apply -f calculator.yaml
            ./kubectl apply -f hazelcast.yaml
            sleep 15
          '''
        }
      }
    }
    stage('Run Tests') {
      steps {
        git 'https://github.com/meadowlark1/Continuous-Delivery-with-Docker-and-Jenkins-Second-Edition.git'
        container('gradle') {
          sh '''
            cd Chapter09/sample3
            test $(curl calculator-service:8080/sum?a=6\\&b=2) -eq 8 \
              && echo 'Addition Test Pass!' \
              || echo 'Addition Test Failed!'
            test $(curl calculator-service:8080/div?a=8\\&b=2) -eq 4 \
              && echo 'Divide Test Pass!' \
              || echo 'Divide Test Fail!'
            test $(curl calculator-service:8080/div?a=8\\&b=0) -eq 0 \
              && echo 'Divide by Zero Test, cannot divide by Zero.' 
          '''
        }
      }
    }
  }
  post {
    always {
      container('centos') {
        sh '''
          echo 'Test complete. Clean up.'
          cd Chapter08/sample1
          ./kubectl delete service calculator-service
          ./kubectl delete service hazelcast
        #  DEP_1=`./kubectl get deployment -o custom-columns=":metadata.name" --no-headers=true -l app=calculator`
        #  DEP_2=`./kubectl get deployment -o custom-columns=":metadata.name" --no-headers=true -l app=hazelcast`
        #  [[ ! -z "$DEP_1" ]] && ./kubectl delete deployment $DEP_1 || echo "error cannot delete calculator deployment."
        #  [[ ! -z "$DEP_2" ]] && ./kubectl delete deployment $DEP_2 || echo "error cannot delete hazelcast deployment."
        #  ./kubectl get pod -n devops-tools
        #  ./kubectl get services -n devops-tools
        #  ./kubectl get deployments -n devops-tools
        '''
      }
    }
  }
}